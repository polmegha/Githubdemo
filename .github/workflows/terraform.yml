# # name: Terraform Pipeline

# # on:
# #   push:
# #     branches:
# #       - main

# # jobs:
# #   terraform:
# #     runs-on: ubuntu-latest

# #     steps:
# #     - name: Checkout code
# #       uses: actions/checkout@v4

# #     - name: Setup Terraform
# #       uses: hashicorp/setup-terraform@v3
# #       with:
# #         terraform_version: 1.6.6

# #     - name: Azure Login
# #       uses: azure/login@v1
# #       with:
# #         creds: ${{ secrets.AZURE_CREDENTIALS }}

# #     - name: Terraform Init
# #       run: terraform init

# #     - name: Terraform Plan
# #       run: terraform plan

# #     - name: Terraform Apply
# #       run: terraform apply -auto-approve

#------------ exixting error   ------------------------------------------

# name: Terraform Pipeline

# on:
#   push:
#     branches:
#       - main
#   workflow_dispatch:

# permissions:
#   contents: read

# jobs:
#   terraform:
#     runs-on: ubuntu-latest
#     timeout-minutes: 20

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup Terraform
#         uses: hashicorp/setup-terraform@v3
#         with:
#           terraform_version: 1.6.6

#       - name: Azure Login
#         uses: azure/login@v2
#         with:
#           creds: ${{ secrets.AZURE_CREDENTIALS }}

#       - name: Terraform Init
#         run: terraform init -input=false


      # - name: Import existing Resource Group (if already exists)
      #   env:
      #     ARM_USE_AZUREAD: "true"
      #     ARM_USE_CLI: "false"
      #     TF_VAR_resource_group_name: ${{ secrets.TF_VAR_RESOURCE_GROUP_NAME }}
      #     TF_VAR_location: ${{ secrets.TF_VAR_LOCATION }}
      #     TF_VAR_vnet_name: ${{ secrets.TF_VAR_VNET_NAME }}
      #     TF_VAR_vnet_address_space: ${{ secrets.TF_VAR_VNET_ADDRESS_SPACE }}
      #     TF_VAR_subnet_name: ${{ secrets.TF_VAR_SUBNET_NAME }}
      #     TF_VAR_subnet_address_prefix: ${{ secrets.TF_VAR_SUBNET_ADDRESS_PREFIX }}
      #     TF_VAR_tags: ${{ secrets.TF_VAR_TAGS }}
      #   run: |
      #     set -e
      #     RG_ID="/subscriptions/${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}/resourceGroups/${{ secrets.TF_VAR_RESOURCE_GROUP_NAME }}"

      #     echo "Checking if RG is already in Terraform state..."
      #     if terraform state list | grep -q "^azurerm_resource_group.rg1$"; then
      #       echo "RG already in state. Skipping import."
      #       exit 0
      #     fi

      #     echo "Checking if RG exists in Azure..."
      #     if az group show --name "${{ secrets.TF_VAR_RESOURCE_GROUP_NAME }}" >/dev/null 2>&1; then
      #       echo "RG exists in Azure. Importing into state..."
      #       terraform import azurerm_resource_group.rg1 "$RG_ID"
      #     else
      #       echo "RG does not exist in Azure. Terraform will create it."
      #     fi


      # - name: Terraform Plan
      #   env:
      #     TF_VAR_resource_group_name: ${{ secrets.TF_VAR_RESOURCE_GROUP_NAME }}
      #     TF_VAR_location: ${{ secrets.TF_VAR_LOCATION }}
      #     TF_VAR_vnet_name: ${{ secrets.TF_VAR_VNET_NAME }}
      #     TF_VAR_vnet_address_space: ${{ secrets.TF_VAR_VNET_ADDRESS_SPACE }}
      #     TF_VAR_tags: ${{ secrets.TF_VAR_TAGS }}
      #     TF_VAR_subnet_name: ${{ secrets.TF_VAR_SUBNET_NAME }}
      #     TF_VAR_subnet_address_prefix: ${{ secrets.TF_VAR_SUBNET_ADDRESS_PREFIX }}
      #   run: terraform plan -input=false

      # - name: Terraform Apply
      #   env:
      #     TF_VAR_resource_group_name: ${{ secrets.TF_VAR_RESOURCE_GROUP_NAME }}
      #     TF_VAR_location: ${{ secrets.TF_VAR_LOCATION }}
      #     TF_VAR_vnet_name: ${{ secrets.TF_VAR_VNET_NAME }}
      #     TF_VAR_vnet_address_space: ${{ secrets.TF_VAR_VNET_ADDRESS_SPACE }}
      #     TF_VAR_tags: ${{ secrets.TF_VAR_TAGS }} 
      #     TF_VAR_subnet_name: ${{ secrets.TF_VAR_SUBNET_NAME }}
      #     TF_VAR_subnet_address_prefix: ${{ secrets.TF_VAR_SUBNET_ADDRESS_PREFIX }}
      #   run: terraform apply -auto-approve -input=false

# ---- remove exixt error and add condition to apply only if changes exist ------------------------------------------
name: Terraform Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  terraform:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # IMPORTANT: Uses your backend.tf remote state
      - name: Terraform Init
        env:
          ARM_USE_AZUREAD: true
        run: terraform init -reconfigure -input=false

      # This will print exactly the plan output in logs
      - name: Terraform Plan (print output)
        env:
          ARM_USE_AZUREAD: true
          TF_VAR_resource_group_name: ${{ secrets.TF_VAR_RESOURCE_GROUP_NAME }}
          TF_VAR_location: ${{ secrets.TF_VAR_LOCATION }}
          TF_VAR_vnet_name: ${{ secrets.TF_VAR_VNET_NAME }}
          TF_VAR_vnet_address_space: ${{ secrets.TF_VAR_VNET_ADDRESS_SPACE }}
          TF_VAR_tags: ${{ secrets.TF_VAR_TAGS }}
          TF_VAR_subnet_name: ${{ secrets.TF_VAR_SUBNET_NAME }}
          TF_VAR_subnet_address_prefix: ${{ secrets.TF_VAR_SUBNET_ADDRESS_PREFIX }}

        run: terraform plan -input=false

      # Optional: Apply only if changes exist (safe)
      - name: Terraform Plan (detect changes)
        id: plancheck
        env:
          ARM_USE_AZUREAD: true
          TF_VAR_resource_group_name: ${{ secrets.TF_VAR_RESOURCE_GROUP_NAME }}
          TF_VAR_location: ${{ secrets.TF_VAR_LOCATION }}
          TF_VAR_vnet_name: ${{ secrets.TF_VAR_VNET_NAME }}
          TF_VAR_vnet_address_space: ${{ secrets.TF_VAR_VNET_ADDRESS_SPACE }}
          TF_VAR_tags: ${{ secrets.TF_VAR_TAGS }}
          TF_VAR_subnet_name: ${{ secrets.TF_VAR_SUBNET_NAME }}
          TF_VAR_subnet_address_prefix: ${{ secrets.TF_VAR_SUBNET_ADDRESS_PREFIX }}

        run: |
          set +e
          terraform plan -input=false -detailed-exitcode
          code=$?
          echo "exitcode=$code" >> $GITHUB_OUTPUT
          exit 0

      - name: Terraform Apply (only if changes)
        if: steps.plancheck.outputs.exitcode == '2'
        env:
          ARM_USE_AZUREAD: true
          TF_VAR_resource_group_name: ${{ secrets.TF_VAR_RESOURCE_GROUP_NAME }}
          TF_VAR_location: ${{ secrets.TF_VAR_LOCATION }}
          TF_VAR_vnet_name: ${{ secrets.TF_VAR_VNET_NAME }}
          TF_VAR_vnet_address_space: ${{ secrets.TF_VAR_VNET_ADDRESS_SPACE }}
          TF_VAR_tags: ${{ secrets.TF_VAR_TAGS }}
        run: terraform apply -auto-approve -input=false

      - name: Skip Apply (no changes)
        if: steps.plancheck.outputs.exitcode == '0'
        run: echo "No changes. Your infrastructure matches the configuration."




# #last one
# name: Terraform Pipeline

# on:
#   push:
#     branches: [ main ]
#   workflow_dispatch:

# permissions:
#   contents: read
#   id-token: write   # REQUIRED for OIDC login

# jobs:
#   terraform:
#     runs-on: ubuntu-latest
#     timeout-minutes: 30

#     env:
#       # Terraform auth (OIDC) - avoids Azure CLI "User only" issue
#       ARM_USE_OIDC: "true"
#       ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
#       ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
#       ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

#       # For azurerm backend using Azure AD auth (recommended)
#       ARM_USE_AZUREAD: "true"
#       ARM_USE_CLI: "false"

#       # Your TF variables
#       TF_VAR_location: ${{ secrets.TF_VAR_LOCATION }}
#       TF_VAR_subnet_name: ${{ secrets.TF_VAR_SUBNET_NAME }}
#       TF_VAR_subnet_address_prefix: ${{ secrets.TF_VAR_SUBNET_ADDRESS_PREFIX }}
#       TF_VAR_tags: ${{ secrets.TF_VAR_TAGS }}

#       # If you still use these vars in code
#       TF_VAR_resource_group_name: ${{ secrets.TF_VAR_RESOURCE_GROUP_NAME }}
#       TF_VAR_vnet_name: ${{ secrets.TF_VAR_VNET_NAME }}
#       TF_VAR_vnet_address_space: ${{ secrets.TF_VAR_VNET_ADDRESS_SPACE }}

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup Terraform
#         uses: hashicorp/setup-terraform@v3
#         with:
#           terraform_version: 1.6.6

#       # OIDC Azure login (no AZURE_CREDENTIALS needed)
#       - name: Azure Login (OIDC)
#         uses: azure/login@v2
#         with:
#           client-id: ${{ secrets.AZURE_CLIENT_ID }}
#           tenant-id: ${{ secrets.AZURE_TENANT_ID }}
#           subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

#       - name: Terraform Init
#         run: terraform init -reconfigure -input=false

#       - name: Terraform Plan (detect changes + save plan)
#         id: plancheck
#         run: |
#           set +e
#           terraform plan -input=false -detailed-exitcode -out=tfplan
#           EXITCODE=$?
#           echo "Terraform plan exit code: $EXITCODE"
#           echo "exitcode=$EXITCODE" >> $GITHUB_OUTPUT

#           # 1 = error
#           if [ "$EXITCODE" -eq 1 ]; then
#             exit 1
#           fi

#           # 0 (no changes) or 2 (changes)
#           exit 0

#       - name: Terraform Apply (only if changes)
#         if: steps.plancheck.outputs.exitcode == '2'
#         run: terraform apply -auto-approve -input=false tfplan

#       - name: Skip Apply (no changes)
#         if: steps.plancheck.outputs.exitcode == '0'
#         run: echo "No changes. Your infrastructure matches the configuration."
